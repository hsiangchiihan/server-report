<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç¾å ´ç›£æ§æ•¸æ“šé¡¯ç¤ºæ¿</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    /* ç‹€æ…‹æŒ‡ç¤ºå™¨ - çµ±ä¸€æ¨£å¼ */
    #status {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      padding: 12px 20px;
      border-radius: 25px;
      text-align: center;
      margin-bottom: 30px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-weight: 500;
    }

    .status-connected {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
    }

    .status-disconnected {
      background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%) !important;
    }

    .status-connecting {
      background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%) !important;
      color: #212529 !important;
    }

    /* çµ±ä¸€ç¶²æ ¼ä½ˆå±€ */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    /* çµ±ä¸€ç›£æ§å€å¡Šæ¨£å¼ */
    .dashboard-box {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .dashboard-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    /* çµ±ä¸€å€å¡Šæ¨™é¡Œæ¨£å¼ */
    .block-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .block-icon {
      font-size: 2rem;
      margin-right: 15px;
    }

    .block-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: #333;
      margin: 0;
    }

    /* çµ±ä¸€æ¨™ç±¤æ¨£å¼ */
    .label {
      font-weight: 500;
      color: #555;
      font-size: 1rem;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* çµ±ä¸€æ•¸æ“šé¡¯ç¤ºæ¨£å¼ */
    .data-value {
      font-weight: 700;
      color: #2c5aa0;
      font-size: 1.1rem;
      margin-bottom: 15px;
      padding: 10px 15px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }

    /* çµ±ä¸€é …ç›®æ¨£å¼ */
    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f5f5f5;
      transition: background-color 0.2s ease;
    }

    .stat-item:hover {
      background-color: #f8f9fa;
      margin: 0 -25px;
      padding-left: 25px;
      padding-right: 25px;
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-label {
      font-weight: 500;
      color: #555;
    }

    .stat-value {
      font-weight: 700;
      color: #2c5aa0;
      font-size: 1.1rem;
    }

    /* é€²åº¦æ¢å®¹å™¨ */
    .progress-container {
      margin-bottom: 20px;
    }

    .progress {
      height: 12px;
      background: #e9ecef;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress-bar {
      background: linear-gradient(90deg, #dc3545, #fd7e14);
      transition: width 0.3s ease;
      border-radius: 6px;
      height: 100%;
    }

    /* è¡€é‡é€²åº¦æ¢ç‰¹æ®Šæ¨£å¼ */
    .hp-progress-bar {
      background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
      transition: width 0.3s ease;
      border-radius: 6px;
      height: 100%;
    }

    .hp-progress-bar.low-hp {
      background: linear-gradient(90deg, #dc3545, #e74c3c);
    }

    .hp-progress-bar.medium-hp {
      background: linear-gradient(90deg, #ffc107, #fd7e14);
    }

    .hp-progress-bar.high-hp {
      background: linear-gradient(90deg, #28a745, #20c997);
    }

    /* é€Ÿåº¦è¨ˆæ¨£å¼ */
    .speed-container {
      width: 160px;
      height: 160px;
      border: 8px solid #e9ecef;
      border-radius: 50%;
      position: relative;
      margin: 20px auto;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .speed-fill {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: conic-gradient(from 0deg,
          #667eea 0deg,
          #667eea var(--angle, 0deg),
          #e9ecef var(--angle, 0deg));
      transition: background 0.3s ease;
    }

    .speed-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.6rem;
      font-weight: 700;
      color: #2c5aa0;
      text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
    }

    /* åœ–è¡¨å®¹å™¨ */
    .chart-container {
      height: 120px;
      position: relative;
      margin: 15px 0;
      padding: 10px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    canvas {
      border-radius: 8px;
    }

    /* ç‹€æ…‹æŒ‡ç¤ºç‡ˆ */
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }

    .status-online {
      background: #28a745;
    }

    .status-offline {
      background: #dc3545;
      animation: none;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }

      100% {
        opacity: 1;
      }
    }

    /* å€’è¨ˆæ™‚å™¨ç‰¹æ®Šæ¨£å¼ */
    .countdown-display {
      font-size: 2.2rem;
      font-weight: 700;
      color: #dc3545;
      text-align: center;
      padding: 15px;
      background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
      border-radius: 12px;
      border: 2px solid #dc3545;
      margin-top: 10px;
      font-family: 'Courier New', monospace;
      letter-spacing: 2px;
    }

    /* èª¿è©¦æŒ‰éˆ• */
    .debug-container {
      text-align: center;
      margin-top: 20px;
    }

    .debug-btn {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .debug-btn:hover {
      transform: translateY(-2px);
    }

    .debug-info {
      margin-top: 15px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      border-left: 4px solid #17a2b8;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 2rem;
      }

      .data-value {
        font-size: 1rem;
      }

      .speed-container {
        width: 120px;
        height: 120px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- <h1>ğŸ® ç©å®¶ç‹€æ…‹ç›£æ§é¢æ¿</h1> -->
    <div id="status" class="status-connecting" style="display: none;">æ­£åœ¨é€£æ¥åˆ°ä¼ºæœå™¨...</div>

    <div id="playerSection"></div>

    <div class="debug-container" style="display: none;">
      <button id="debugBtn" class="debug-btn">é¡¯ç¤ºèª¿è©¦ä¿¡æ¯</button>
    </div>
    <div id="debugInfo" class="debug-info" style="display: none;"></div>
  </div>

  <script>
    // å…¨å±€è®Šé‡
    let wsConnected = false;
    const initialPlayerId = 'player-1';
    let layoutInitialized = false;

    // åˆå§‹åŒ–ç©å®¶æ•¸æ“š
    let players = {};
    players[initialPlayerId] = {
      playerId: initialPlayerId,
      state: "æœªé€£ç·š",
      level: "---",
      hp: 0,
      speed: 0,
      stepCount: 0,
      coinCount: 0,
      playTime: "00:00:00",
      totalPlayTime: "00:00:00",
      countdown: "--:--",
      _lastUpdated: Date.now()
    };

    // åˆå§‹åŒ–æ­·å²æ•¸æ“š
    let stepHistories = {};
    stepHistories[initialPlayerId] = [];

    let coinHistories = {};
    coinHistories[initialPlayerId] = [];

    const charts = {};

    // èª¿è©¦åŠŸèƒ½
    document.getElementById('debugBtn').addEventListener('click', function () {
      const debugInfo = document.getElementById('debugInfo');
      if (debugInfo.style.display === 'none') {
        debugInfo.style.display = 'block';
        const chartKeys = Object.keys(charts);
        const playersInfo = Object.keys(players).map(id => {
          return `Player ${id}: æ­¥æ•¸=${players[id].stepCount}, é‡‘å¹£=${players[id].coinCount}`;
        });

        debugInfo.innerHTML = `
          <h5>èª¿è©¦ä¿¡æ¯</h5>
          <p>WebSocket é€£æ¥ç‹€æ…‹: ${wsConnected ? 'å·²é€£æ¥' : 'æœªé€£æ¥'}</p>
          <p>å‰µå»ºçš„åœ–è¡¨æ•¸: ${chartKeys.length}</p>
          <p>åœ–è¡¨ID: ${chartKeys.join(', ')}</p>
          <p>ç©å®¶æ•¸æ“š: ${playersInfo.join('<br>')}</p>
          <p>æ­¥æ•¸æ­·å²è¨˜éŒ„é•·åº¦: ${Object.keys(stepHistories).map(id => `${id}=${stepHistories[id].length}`).join(', ')}</p>
          <p>ä½ˆå±€å·²åˆå§‹åŒ–: ${layoutInitialized}</p>
        `;
      } else {
        debugInfo.style.display = 'none';
      }
    });

    // ç‹€æ…‹é¡¯ç¤ºå‡½æ•¸
    function updateConnectionStatus(state) {
      const statusElement = document.getElementById('status');
      statusElement.style.display = 'block';
      statusElement.className = '';
      statusElement.classList.add(state === 'connected' ? 'status-connected' :
        state === 'connecting' ? 'status-connecting' : 'status-disconnected');

      statusElement.textContent = state === 'connected' ? 'ğŸŸ¢ å·²é€£æ¥åˆ°ä¼ºæœå™¨' :
        state === 'connecting' ? 'ğŸŸ¡ æ­£åœ¨é€£æ¥åˆ°ä¼ºæœå™¨...' : 'ğŸ”´ ä¼ºæœå™¨é€£æ¥å¤±æ•—ï¼Œä½¿ç”¨æ¨¡æ“¬æ•¸æ“š';
    }

    // åˆå§‹åŒ– WebSocket é€£æ¥
    const ws = new WebSocket("wss://maze-f4s4.onrender.com");
    // const ws = new WebSocket("ws://localhost:3000");

    ws.onopen = () => {
      wsConnected = true;
      updateConnectionStatus('connected');
    };

    ws.onerror = (error) => {
      console.error('WebSocket éŒ¯èª¤:', error);
      wsConnected = false;
      updateConnectionStatus('disconnected');
      useSimulatedData();
    };

    ws.onclose = () => {
      wsConnected = false;
      updateConnectionStatus('disconnected');
      useSimulatedData();
    };

    // ä½¿ç”¨æ¨¡æ“¬æ•¸æ“šé€²è¡Œæ¸¬è©¦
    function useSimulatedData() {
      if (wsConnected) return;

      console.log('ğŸŸ¡ ä½¿ç”¨éœæ…‹æ¨¡æ“¬æ•¸æ“š');

      const playerId = initialPlayerId;

      players[playerId] = {
        playerId: playerId,
        state: "ç­‰å¾…ä¸­",
        level: "ç¬¬1é—œ",
        hp: 80,
        speed: 0,
        stepCount: 0,
        coinCount: 0,
        playTime: "00:00:00",
        totalPlayTime: "00:00:00",
        countdown: "00:00",
        _lastUpdated: Date.now()
      };

      const now = new Date();
      stepHistories[playerId] = [{ x: now, y: 0 }];
      coinHistories[playerId] = [{ x: now, y: 0 }];

      if (!layoutInitialized) {
        createInitialLayout();
      }

      updateCharts(playerId);
      updateDisplay(playerId);

      if (window.simulationInterval) {
        clearInterval(window.simulationInterval);
        window.simulationInterval = null;
      }
    }

    // æ›´æ–°åœ–è¡¨æ•¸æ“š
    function updateCharts(playerId) {
      const stepChartId = `step-chart-${playerId}`;
      const coinChartId = `coin-chart-${playerId}`;

      if (charts[stepChartId]) {
        charts[stepChartId].data.datasets[0].data = stepHistories[playerId];
        charts[stepChartId].update('none');
      }

      if (charts[coinChartId]) {
        charts[coinChartId].data.datasets[0].data = coinHistories[playerId];
        charts[coinChartId].update('none');
      }
    }

    // å»ºç«‹åˆå§‹é é¢çµæ§‹
    function createInitialLayout() {
      if (layoutInitialized) {
        console.log('ä½ˆå±€å·²åˆå§‹åŒ–ï¼Œä¸å†é‡è¤‡å‰µå»º');
        return;
      }

      console.log('å‰µå»ºåˆå§‹ä½ˆå±€');
      const section = document.getElementById("playerSection");
      section.innerHTML = '';

      const playerId = initialPlayerId;
      const player = players[playerId];

      if (!player) {
        console.error('æ‰¾ä¸åˆ°ç©å®¶æ•¸æ“š:', playerId);
        return;
      }

      const playerDiv = document.createElement('div');
      playerDiv.classList.add('dashboard-grid');
      playerDiv.id = `player-container-${playerId}`;

      const leftBox = document.createElement('div');
      leftBox.classList.add('dashboard-box');

      const rightBox = document.createElement('div');
      rightBox.classList.add('dashboard-box');

      // å·¦å´æ•¸æ“š - éŠæˆ²é€²åº¦ - ä½¿ç”¨çµ±ä¸€çš„æ¨£å¼
      leftBox.innerHTML = `
        <div class="block-header">
          <span class="block-icon">ğŸ®</span>
          <h2 class="block-title">éŠæˆ²é€²åº¦</h2>
        </div>
        
        <div class="stat-item">
          <div class="stat-label">
            <span class="status-indicator status-online" id="status-indicator-${playerId}"></span>
            è§’è‰²ç‹€æ…‹
          </div>
          <span id="status-${playerId}" class="stat-value">${player.state}</span>
        </div>
        
        <div class="stat-item">
          <span class="stat-label">ğŸ“ è§’è‰²æ‰€åœ¨é—œå¡</span>
          <span id="level-${playerId}" class="stat-value">${player.level}</span>
        </div>
        
        <div class="stat-item">
          <span class="stat-label">â±ï¸ ç´¯ç©éŠç©æ™‚æ•¸</span>
          <span id="playTime-${playerId}" class="stat-value">${player.totalPlayTime || player.playTime}</span>
        </div>
        
        <div class="stat-item">
          <span class="stat-label">ğŸ‘£ ç›®å‰æ­¥æ•¸</span>
          <span id="stepCount-${playerId}" class="stat-value">${player.stepCount}</span>
        </div>
        <div class="chart-container">
          <canvas id="step-chart-${playerId}"></canvas>
        </div>
        
        <div class="stat-item">
          <span class="stat-label">ğŸª™ ç›®å‰é‡‘å¹£æ•¸</span>
          <span id="coinCount-${playerId}" class="stat-value">${player.coinCount}</span>
        </div>
        <div class="chart-container">
          <canvas id="coin-chart-${playerId}"></canvas>
        </div>
      `;

      // å³å´æ•¸æ“š - è§’è‰²ç‹€æ…‹ - ä½¿ç”¨çµ±ä¸€çš„æ¨£å¼
      rightBox.innerHTML = `
        <div class="block-header">
          <span class="block-icon">âš¡</span>
          <h2 class="block-title">è§’è‰²ç‹€æ…‹</h2>
        </div>
        
        <div class="stat-item">
          <span class="stat-label">â¤ï¸ ç›®å‰è¡€é‡</span>
          <span id="hp-${playerId}" class="stat-value">${player.hp}/100</span>
        </div>
        <div class="progress-container">
          <div class="progress">
            <div id="hp-bar-${playerId}" class="hp-progress-bar ${player.hp > 70 ? 'high-hp' : player.hp > 30 ? 'medium-hp' : 'low-hp'}" style="width: ${player.hp}%"></div>
          </div>
        </div>
        
        <div class="stat-item">
          <span class="stat-label">âš¡ è§’è‰²é€Ÿåº¦</span>
          <span id="speed-value-${playerId}" class="stat-value">${player.speed.toFixed(2)}</span>
        </div>
        <div id="speed-container-${playerId}" class="speed-container" style="--angle:${Math.min(Math.max(player.speed, 0), 30) * 12}deg">
          <div class="speed-fill"></div>
          <div id="speed-label-${playerId}" class="speed-label">${player.speed.toFixed(2)}</div>
        </div>
        
        <div class="stat-item">
          <span class="stat-label">â° å€’è¨ˆæ™‚å™¨</span>
          <span class="stat-value">${player.countdown || '--:--'}</span>
        </div>
        <div id="countdown-${playerId}" class="countdown-display">${player.countdown || '--:--'}</div>
      `;

      playerDiv.appendChild(leftBox);
      playerDiv.appendChild(rightBox);
      section.appendChild(playerDiv);

      initializeCharts(playerId);
      layoutInitialized = true;
    }

    // æ›´æ–°é¡¯ç¤ºæ•¸æ“š
    function updateDisplay(playerId) {
      const player = players[playerId];
      if (!player) {
        console.error('æ‰¾ä¸åˆ°ç©å®¶æ•¸æ“š:', playerId);
        return;
      }

      // æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºç‡ˆ
      const statusIndicator = document.getElementById(`status-indicator-${playerId}`);
      if (statusIndicator) {
        statusIndicator.className = player.state === 'é›¢ç·š' ? 'status-indicator status-offline' : 'status-indicator status-online';
      }

      // æ›´æ–°å„é …æ•¸æ“š
      const statusEl = document.getElementById(`status-${playerId}`);
      if (statusEl) statusEl.textContent = player.state;

      const levelEl = document.getElementById(`level-${playerId}`);
      if (levelEl) levelEl.textContent = player.level || 'ç¬¬1é—œ';

      const playTimeEl = document.getElementById(`playTime-${playerId}`);
      if (playTimeEl) playTimeEl.textContent = player.totalPlayTime || player.playTime;

      const stepCountEl = document.getElementById(`stepCount-${playerId}`);
      if (stepCountEl) stepCountEl.textContent = player.stepCount;

      const coinCountEl = document.getElementById(`coinCount-${playerId}`);
      if (coinCountEl) coinCountEl.textContent = player.coinCount;

      const hpEl = document.getElementById(`hp-${playerId}`);
      if (hpEl) hpEl.textContent = `${player.hp}/100`;

      const hpBarEl = document.getElementById(`hp-bar-${playerId}`);
      if (hpBarEl) {
        hpBarEl.style.width = `${player.hp}%`;
        // æ ¹æ“šè¡€é‡å‹•æ…‹æ›´æ–°é¡è‰²é¡åˆ¥
        hpBarEl.className = `hp-progress-bar ${player.hp > 70 ? 'high-hp' : player.hp > 30 ? 'medium-hp' : 'low-hp'}`;
      }

      const speedValueEl = document.getElementById(`speed-value-${playerId}`);
      if (speedValueEl) speedValueEl.textContent = player.speed.toFixed(2);

      const speedLabelEl = document.getElementById(`speed-label-${playerId}`);
      if (speedLabelEl) speedLabelEl.textContent = player.speed.toFixed(2);

      const speedContainerEl = document.getElementById(`speed-container-${playerId}`);
      if (speedContainerEl) {
        const angle = Math.min(Math.max(player.speed, 0), 30) * 12;
        speedContainerEl.style.setProperty('--angle', `${angle}deg`);
      }

      const countdownEl = document.getElementById(`countdown-${playerId}`);
      if (countdownEl) countdownEl.textContent = player.countdown || '--:--';
    }

    // åˆå§‹åŒ–åœ–è¡¨
    function initializeCharts(playerId) {
      const stepChartId = `step-chart-${playerId}`;
      const coinChartId = `coin-chart-${playerId}`;

      if (charts[stepChartId] || charts[coinChartId]) {
        console.log('åœ–è¡¨å·²å­˜åœ¨ï¼Œä¸éœ€è¦é‡æ–°å‰µå»º');
        return;
      }

      // åˆå§‹åŒ–æ­¥æ•¸åœ–è¡¨
      const stepCtx = document.getElementById(stepChartId)?.getContext("2d");
      if (stepCtx) {
        if (!stepHistories[playerId]) stepHistories[playerId] = [];

        if (stepHistories[playerId].length === 0) {
          const now = new Date();
          for (let i = 5; i >= 0; i--) {
            const time = new Date(now.getTime() - i * 60000);
            stepHistories[playerId].push({
              x: time,
              y: players[playerId].stepCount || 0
            });
          }
        }

        charts[stepChartId] = new Chart(stepCtx, {
          type: 'line',
          data: {
            datasets: [{
              label: 'æ­¥æ•¸è®ŠåŒ–',
              data: stepHistories[playerId],
              borderColor: '#667eea',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              tension: 0.4,
              pointRadius: 0,
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 0 },
            plugins: {
              legend: { display: false },
              tooltip: { mode: 'index', intersect: false }
            },
            scales: {
              x: {
                type: 'time',
                time: { unit: 'minute' },
                display: true,
                grid: { color: 'rgba(0,0,0,0.1)' }
              },
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(0,0,0,0.1)' }
              }
            }
          }
        });
      }

      // åˆå§‹åŒ–é‡‘å¹£åœ–è¡¨
      const coinCtx = document.getElementById(coinChartId)?.getContext("2d");
      if (coinCtx) {
        if (!coinHistories[playerId]) coinHistories[playerId] = [];

        if (coinHistories[playerId].length === 0) {
          const now = new Date();
          for (let i = 5; i >= 0; i--) {
            const time = new Date(now.getTime() - i * 60000);
            coinHistories[playerId].push({
              x: time,
              y: players[playerId].coinCount || 0
            });
          }
        }

        charts[coinChartId] = new Chart(coinCtx, {
          type: 'line',
          data: {
            datasets: [{
              label: 'é‡‘å¹£è®ŠåŒ–',
              data: coinHistories[playerId],
              borderColor: '#ffc107',
              backgroundColor: 'rgba(255, 193, 7, 0.1)',
              tension: 0.4,
              pointRadius: 0,
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 0 },
            plugins: {
              legend: { display: false },
              tooltip: { mode: 'index', intersect: false }
            },
            scales: {
              x: {
                type: 'time',
                time: { unit: 'minute' },
                display: true,
                grid: { color: 'rgba(0,0,0,0.1)' }
              },
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(0,0,0,0.1)' }
              }
            }
          }
        });
      }
    }

    function replaceOrAddPlayer(p) {
      const playerId = initialPlayerId;

      players[playerId] = {
        ...p,
        playerId: playerId,
        _lastUpdated: Date.now()
      };

      if (!stepHistories[playerId]) stepHistories[playerId] = [];
      if (!coinHistories[playerId]) coinHistories[playerId] = [];

      stepHistories[playerId].push({ x: new Date(), y: p.stepCount });
      if (stepHistories[playerId].length > 600) stepHistories[playerId].shift();

      coinHistories[playerId].push({ x: new Date(), y: p.coinCount });
      if (coinHistories[playerId].length > 600) coinHistories[playerId].shift();

      updateCharts(playerId);
      updateDisplay(playerId);
    }

    ws.onmessage = (msg) => {
      try {
        const { type, data } = JSON.parse(msg.data);
        if (type === "init") {
          if (Array.isArray(data) && data.length > 0) {
            replaceOrAddPlayer(data[0]);
          }
        } else if (type === "update") {
          replaceOrAddPlayer(data);
        }
      } catch (error) {
        console.error('è™•ç† WebSocket æ¶ˆæ¯æ™‚å‡ºéŒ¯:', error);
      }
    };

    // æ¯ç§’æª¢æŸ¥ç©å®¶é€£æ¥ç‹€æ…‹
    setInterval(() => {
      const playerId = initialPlayerId;
      const player = players[playerId];

      if (player) {
        const now = Date.now();
        const last = player._lastUpdated || 0;

        if (now - last > 5000 && player.state !== 'é›¢ç·š') {
          players[playerId] = {
            ...player,
            state: 'é›¢ç·š',
            _lastUpdated: now
          };

          updateDisplay(playerId);
        }
      }
    }, 1000);

    // é é¢è¼‰å…¥æ™‚å‰µå»ºåˆå§‹å¸ƒå±€
    window.addEventListener('DOMContentLoaded', () => {
      updateConnectionStatus('connecting');
      createInitialLayout();

      setTimeout(() => {
        if (!wsConnected) {
          updateConnectionStatus('disconnected');
          useSimulatedData();
        }
      }, 5000);
    });
  </script>
</body>

</html>