<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>æ•¸æ“šçµ±è¨ˆ</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* å¾¹åº•éš±è—æ‰€æœ‰æ»¾å‹•æ¢ */
    *::-webkit-scrollbar {
      display: none;
      width: 0 !important;
      height: 0 !important;
    }

    * {
      -ms-overflow-style: none !important;
      /* IE and Edge */
      scrollbar-width: none !important;
      /* Firefox */
    }

    html,
    body {
      overflow-x: hidden;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stats-block {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stats-block:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .block-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .block-icon {
      font-size: 2rem;
      margin-right: 15px;
    }

    .block-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: #333;
      margin: 0;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f5f5f5;
      transition: background-color 0.2s ease;
    }

    .stat-item:hover {
      background-color: #f8f9fa;
      margin: 0 -25px;
      padding-left: 25px;
      padding-right: 25px;
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-label {
      font-weight: 500;
      color: #555;
    }

    .stat-value {
      font-weight: 700;
      color: #2c5aa0;
      font-size: 1.1rem;
    }

    .overview-block {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #8a9ba8 0%, #7c8db5 100%);
      color: white;
      text-align: center;
    }

    .overview-block .block-title {
      color: white;
    }

    .overview-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .overview-item {
      background: rgba(255, 255, 255, 0.18);
      padding: 20px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .overview-number {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .overview-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .no-data {
      text-align: center;
      color: #999;
      font-style: italic;
      padding: 20px;
    }

    .loading {
      text-align: center;
      color: white;
      font-size: 1.5rem;
      margin-top: 50px;
    }

    .progress-bar {
      background: #e0e0e0;
      border-radius: 10px;
      height: 8px;
      overflow: hidden;
      margin-left: 10px;
      flex: 1;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #8BC34A);
      border-radius: 10px;
      transition: width 0.3s ease;
    }

    .level-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .level-info {
      display: flex;
      align-items: center;
      flex: 1;
    }

    .level-progress {
      display: flex;
      align-items: center;
      flex: 1;
      margin: 0 15px;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 2rem;
      }

      .overview-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
  <script>
    const baseUrl = "https://script.google.com/macros/s/AKfycbyPBgJEWE5pVuZnxyX94AgFTLxl_lzhWJdlVRZgwjEPrer4PCRrZHslgT-RMowV6fPM/exec";

    async function fetchAllData() {
      try {
        const res = await fetch(`${baseUrl}?action=listSheets`);
        const sheetNames = await res.json();

        const allData = [];
        for (const name of sheetNames) {
          const r = await fetch(`${baseUrl}?sheet=${name}`);
          const json = await r.json();
          allData.push(...json);
        }

        analyzeData(allData);
      } catch (error) {
        document.getElementById("stats").innerHTML = `
          <div class="stats-block">
            <p style="color: red; text-align: center;">è®€å–æ•¸æ“šå¤±æ•—: ${error.message}</p>
          </div>
        `;
      }
    }

    function analyzeData(data) {
      console.log("ç¸½æ•¸æ“šç­†æ•¸:", data.length);
      console.log("å‰3ç­†æ•¸æ“š:", data.slice(0, 3));
      console.log("isCleared æ¬„ä½å€¼:", [...new Set(data.map(row => row.isCleared))]);

      const levelStats = {};
      const itemStats = {};
      const playTimePerDay = {};
      const clearTimeStats = {};
      const stepStats = {};
      const damageStats = {};
      const coinPerDay = {};

      for (const row of data) {
        const level = row.level || "1";
        const cleared = row.isCleared === "TRUE" || row.isCleared === "true" || row.isCleared === true || row.isCleared === "1";
        const sessionDate = row.sessionDate;

        // 1. é—œå¡é€šé—œç‡çµ±è¨ˆ
        levelStats[level] = levelStats[level] || { total: 0, cleared: 0 };
        levelStats[level].total++;
        if (cleared) levelStats[level].cleared++;

        // 2. å•†å“è³¼è²·çµ±è¨ˆ - ä¿®æ”¹ç‚ºä¸­æ–‡é¡¯ç¤º
        if (row.itemsBought && row.itemsBought !== "None") {
          row.itemsBought.split(",").forEach(entry => {
            const [item, count] = entry.trim().split(":");
            if (item && count) {
              // å°‡è‹±æ–‡å•†å“åç¨±è½‰æ›ç‚ºä¸­æ–‡
              const itemNameMap = {
                'life': 'è¡€é‡',
                'clock': 'æ™‚é–“',
                'speed': 'é€Ÿåº¦',
                'revive': 'å¾©æ´»'
              };
              const displayName = itemNameMap[item.toLowerCase()] || item;
              itemStats[displayName] = (itemStats[displayName] || 0) + parseInt(count || 0);
            }
          });
        }

        // 3. æ¯æ—¥éŠç©æ™‚æ•¸
        if (row.playTime) {
          const secs = timeToSeconds(row.playTime);
          //   console.log(`è™•ç†æ™‚é–“: ${row.playTime} -> ${secs}ç§’`); // èª¿è©¦ä¿¡æ¯

          // æ¸…ç†æ—¥æœŸæ ¼å¼ - ç§»é™¤æ™‚é–“éƒ¨åˆ†ï¼Œåªä¿ç•™æ—¥æœŸ
          // const cleanDate = sessionDate ? sessionDate.split('T')[0] : sessionDate;
          const cleanDate = sessionDate ? formatDateToTaiwan(sessionDate) : sessionDate;

          if (!isNaN(secs) && secs > 0) {
            playTimePerDay[cleanDate] = (playTimePerDay[cleanDate] || 0) + secs;
          }

          // 4. é€šé—œå¹³å‡è€—æ™‚çµ±è¨ˆ
          if (cleared && !isNaN(secs) && secs > 0) {
            clearTimeStats[level] = clearTimeStats[level] || [];
            clearTimeStats[level].push(secs);
          }
        }

        // 5. é€šé—œå¹³å‡æ­¥æ•¸çµ±è¨ˆ
        if (cleared && row.stepCount) {
          stepStats[level] = stepStats[level] || [];
          stepStats[level].push(parseInt(row.stepCount || 0));
        }

        // 6. å¹³å‡æ‰£è¡€é‡çµ±è¨ˆ
        if (row.damageTaken !== undefined) {
          damageStats[level] = damageStats[level] || [];
          damageStats[level].push(parseInt(row.damageTaken || 0));
        }

        // 7. æ¯æ—¥é‡‘å¹£çµ±è¨ˆ
        if (row.coinCount) {
          // æ¸…ç†æ—¥æœŸæ ¼å¼ - ç§»é™¤æ™‚é–“éƒ¨åˆ†ï¼Œåªä¿ç•™æ—¥æœŸ
          // const cleanDate = sessionDate ? sessionDate.split('T')[0] : sessionDate;
          const cleanDate = sessionDate ? formatDateToTaiwan(sessionDate) : sessionDate;

          coinPerDay[cleanDate] = (coinPerDay[cleanDate] || 0) + parseInt(row.coinCount || 0);
        }
      }

      // è¨ˆç®—ç¸½é«”çµ±è¨ˆ
      const totalGames = data.length;
      const totalCleared = data.filter(row =>
        row.isCleared === "TRUE" || row.isCleared === "true" || row.isCleared === true || row.isCleared === "1"
      ).length;
      const totalDamage = data.reduce((sum, row) => sum + parseInt(row.damageTaken || 0), 0);

      // ä¿®æ­£ç¸½éŠç©æ™‚é–“è¨ˆç®—
      const totalPlayTime = Object.values(playTimePerDay).reduce((sum, time) => {
        const validTime = isNaN(time) ? 0 : time;
        return sum + validTime;
      }, 0);

      // èª¿è©¦ä¿¡æ¯
      //   console.log("playTimePerDay:", playTimePerDay);
      //   console.log("totalPlayTime:", totalPlayTime);
      //   console.log("é€šé—œçµ±è¨ˆ stepStats:", stepStats);
      console.log("é€šé—œè³‡æ–™è©³ç´°:", data.filter(row => {
        const cleared = row.isCleared === "TRUE" || row.isCleared === "true" || row.isCleared === true || row.isCleared === "1";
        return cleared;
      }).map(row => ({
        level: row.level,
        isCleared: row.isCleared,
        stepCount: row.stepCount
      })));

      document.getElementById("stats").innerHTML = `
        <div class="stats-grid">
          <!-- ç¸½è¦½çµ±è¨ˆ -->
          <div class="stats-block overview-block">
            <div class="block-header">
              <span class="block-icon">ğŸ“Š</span>
              <h2 class="block-title">ç¸½è¦½çµ±è¨ˆ</h2>
            </div>
            <div class="overview-stats">
              <div class="overview-item">
                <div class="overview-number">${totalGames}</div>
                <div class="overview-label">ç¸½éŠæˆ²æ¬¡æ•¸</div>
              </div>
              <div class="overview-item">
                <div class="overview-number">${totalCleared}</div>
                <div class="overview-label">ç¸½é€šé—œæ¬¡æ•¸</div>
              </div>
              <div class="overview-item">
                <div class="overview-number">${totalGames > 0 ? ((totalCleared / totalGames) * 100).toFixed(1) : 0}%</div>
                <div class="overview-label">æ•´é«”é€šé—œç‡</div>
              </div>
              <div class="overview-item">
                <div class="overview-number">${totalPlayTime > 0 ? Math.round(totalPlayTime / 60) : 0}</div>
                <div class="overview-label">ç¸½éŠç©åˆ†é˜</div>
              </div>
            </div>
          </div>

          <!-- é—œå¡é€šé—œç‡çµ±è¨ˆ -->
          <div class="stats-block">
            <div class="block-header">
              <span class="block-icon">ğŸ¯</span>
              <h2 class="block-title">é—œå¡é€šé—œç‡</h2>
            </div>
            ${Object.keys(levelStats).length > 0 ?
          Object.entries(levelStats).map(([level, stat]) => {
            const rate = ((stat.cleared / stat.total) * 100);
            return `
                  <div class="level-item">
                    <div class="level-info">
                      <span class="stat-label">ç¬¬ ${level} é—œ</span>
                    </div>
                    <div class="level-progress">
                      <div class="progress-bar">
                        <div class="progress-fill" style="width: ${rate}%"></div>
                      </div>
                    </div>
                    <div class="stat-value">${stat.cleared}/${stat.total} (${rate.toFixed(1)}%)</div>
                  </div>
                `;
          }).join("") :
          '<div class="no-data">æš«ç„¡é—œå¡æ•¸æ“š</div>'
        }
          </div>

          <!-- å•†å“è³¼è²·çµ±è¨ˆ -->
          <div class="stats-block">
            <div class="block-header">
              <span class="block-icon">ğŸ›’</span>
              <h2 class="block-title">å•†å“è³¼è²·çµ±è¨ˆ</h2>
            </div>
            ${Object.keys(itemStats).length > 0 ?
          Object.entries(itemStats)
            .sort(([, a], [, b]) => b - a)
            .map(([item, count]) => `
                  <div class="stat-item">
                    <span class="stat-label">${item}</span>
                    <span class="stat-value">${count} å€‹</span>
                  </div>
                `).join("") :
          '<div class="no-data">ç„¡è³¼è²·è¨˜éŒ„</div>'
        }
          </div>

          <!-- æ¯æ—¥éŠç©æ™‚æ•¸ -->
          <div class="stats-block">
            <div class="block-header">
              <span class="block-icon">â°</span>
              <h2 class="block-title">æ¯æ—¥éŠç©æ™‚æ•¸</h2>
            </div>
            ${Object.entries(playTimePerDay)
          .sort(([dateA], [dateB]) => dateB.localeCompare(dateA))
          .map(([date, secs]) => {
            const hours = Math.floor(secs / 3600);
            const minutes = Math.floor((secs % 3600) / 60);
            const remainingSecs = secs % 60;
            // ç¢ºä¿ä½¿ç”¨æ¸…ç†å¾Œçš„æ—¥æœŸæ ¼å¼ä¾†è¨ˆç®—éŠæˆ²å±€æ•¸
            const gameCount = data.filter(row => {
              // const cleanRowDate = row.sessionDate ? row.sessionDate.split('T')[0] : row.sessionDate;
              const cleanRowDate = row.sessionDate ? formatDateToTaiwan(row.sessionDate) : row.sessionDate;

              return cleanRowDate === date;
            }).length;
            return `
                  <div class="stat-item">
                    <div>
                      <div class="stat-label">${date}</div>
                      <div style="font-size: 0.8rem; color: #888;">${gameCount} å±€éŠæˆ²</div>
                    </div>
                    <span class="stat-value">${hours}:${minutes.toString().padStart(2, '0')}:${remainingSecs.toString().padStart(2, '0')}</span>
                  </div>
                `;
          }).join("")}
          </div>

          <!-- é€šé—œå¹³å‡è€—æ™‚ -->
          <div class="stats-block">
            <div class="block-header">
              <span class="block-icon">âš¡</span>
              <h2 class="block-title">é€šé—œå¹³å‡è€—æ™‚</h2>
            </div>
            ${Object.keys(clearTimeStats).length > 0 ?
          Object.entries(clearTimeStats).map(([level, times]) => {
            const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
            const minutes = Math.floor(avgTime / 60);
            const seconds = Math.floor(avgTime % 60);
            return `
                  <div class="stat-item">
                    <div>
                      <div class="stat-label">ç¬¬ ${level} é—œ</div>
                      <div style="font-size: 0.8rem; color: #888;">åŸºæ–¼ ${times.length} æ¬¡é€šé—œ</div>
                    </div>
                    <span class="stat-value">${minutes}:${seconds.toString().padStart(2, '0')}</span>
                  </div>
                `;
          }).join("") :
          '<div class="no-data">æš«ç„¡é€šé—œæ•¸æ“š</div>'
        }
          </div>

          <!-- é€šé—œå¹³å‡æ­¥æ•¸ -->
          <div class="stats-block">
            <div class="block-header">
              <span class="block-icon">ğŸ‘£</span>
              <h2 class="block-title">é€šé—œå¹³å‡æ­¥æ•¸</h2>
            </div>
            ${Object.keys(stepStats).length > 0 ?
          Object.entries(stepStats).map(([level, steps]) => `
                <div class="stat-item">
                  <div>
                    <div class="stat-label">ç¬¬ ${level} é—œ</div>
                    <div style="font-size: 0.8rem; color: #888;">åŸºæ–¼ ${steps.length} æ¬¡é€šé—œ</div>
                  </div>
                  <span class="stat-value">${(steps.reduce((a, b) => a + b, 0) / steps.length).toFixed(1)} æ­¥</span>
                </div>
              `).join("") :
          '<div class="no-data">æš«ç„¡é€šé—œæ­¥æ•¸æ•¸æ“š</div>'
        }
          </div>

          <!-- å¹³å‡æ‰£è¡€é‡çµ±è¨ˆ -->
          <div class="stats-block">
            <div class="block-header">
              <span class="block-icon">â¤ï¸</span>
              <h2 class="block-title">å¹³å‡æ‰£è¡€é‡</h2>
            </div>
            ${Object.keys(damageStats).length > 0 ?
          Object.entries(damageStats).map(([level, damages]) => `
                <div class="stat-item">
                  <div>
                    <div class="stat-label">ç¬¬ ${level} é—œ</div>
                    <div style="font-size: 0.8rem; color: #888;">åŸºæ–¼ ${damages.length} å±€éŠæˆ²</div>
                  </div>
                  <span class="stat-value">${(damages.reduce((a, b) => a + b, 0) / damages.length).toFixed(1)} é»</span>
                </div>
              `).join("") :
          '<div class="no-data">æš«ç„¡æ‰£è¡€æ•¸æ“š</div>'
        }
            <div class="stat-item" style="border-top: 2px solid #f0f0f0; margin-top: 10px; padding-top: 15px;">
              <span class="stat-label">æ•´é«”å¹³å‡æ‰£è¡€é‡</span>
              <span class="stat-value" style="color: #e74c3c;">${(totalDamage / totalGames).toFixed(1)} é»</span>
            </div>
          </div>

          <!-- æ¯æ—¥é‡‘å¹£çµ±è¨ˆ -->
          <div class="stats-block">
            <div class="block-header">
              <span class="block-icon">ğŸª™</span>
              <h2 class="block-title">æ¯æ—¥é‡‘å¹£çµ±è¨ˆ</h2>
            </div>
            ${Object.entries(coinPerDay)
          .sort(([dateA], [dateB]) => dateB.localeCompare(dateA))
          .map(([date, coins]) => {
            // ç¢ºä¿ä½¿ç”¨æ¸…ç†å¾Œçš„æ—¥æœŸæ ¼å¼ä¾†è¨ˆç®—éŠæˆ²å±€æ•¸
            const gameCount = data.filter(row => {
              // const cleanRowDate = row.sessionDate ? row.sessionDate.split('T')[0] : row.sessionDate;
              const cleanRowDate = row.sessionDate ? formatDateToTaiwan(row.sessionDate) : row.sessionDate;

              return cleanRowDate === date;
            }).length;
            const avgCoins = gameCount > 0 ? (coins / gameCount).toFixed(0) : 0;
            return `
                  <div class="stat-item">
                    <div>
                      <div class="stat-label">${date}</div>
                      <div style="font-size: 0.8rem; color: #888;">å¹³å‡æ¯å±€ ${avgCoins} é‡‘å¹£</div>
                    </div>
                    <span class="stat-value">${coins.toLocaleString()} é‡‘å¹£</span>
                  </div>
                `;
          }).join("")}
          </div>
        </div>
      `;
    }


    function formatDateToTaiwan(dateString) {
      const date = new Date(dateString);
      const taiwanTime = new Date(date.getTime() + 8 * 60 * 60 * 1000);
      return taiwanTime.toISOString().split('T')[0];
    }

    function timeToSeconds(t) {
      if (!t) {
        // console.log("æ™‚é–“ç‚ºç©º:", t);
        return 0;
      }

      try {
        let timeStr = t.toString();
        // console.log("åŸå§‹æ™‚é–“æ ¼å¼:", timeStr);

        // è™•ç† PT00:00.:51 æ ¼å¼ (ISO 8601 duration)
        if (timeStr.startsWith('PT')) {
          // ç§»é™¤ PT å‰ç¶´
          timeStr = timeStr.substring(2);
          //   console.log("ç§»é™¤PTå¾Œ:", timeStr);

          // è™•ç†æ ¼å¼å¦‚ 00:00.:51 æˆ– 00:00:51
          // ä¿®æ­£å¯èƒ½çš„ .:XX æ ¼å¼ç‚º :XX
          timeStr = timeStr.replace(/\.:(\d+)/, ':$1');
          //   console.log("ä¿®æ­£æ ¼å¼å¾Œ:", timeStr);
        }

        // åˆ†å‰²æ™‚é–“
        const parts = timeStr.split(":").map(Number);
        // console.log("æ™‚é–“åˆ†å‰²:", timeStr, "->", parts);

        if (parts.length === 3) {
          const [h, m, s] = parts;
          if (isNaN(h) || isNaN(m) || isNaN(s)) {
            // console.log("æ™‚é–“æ ¼å¼éŒ¯èª¤:", t, parts);
            return 0;
          }
          const result = h * 3600 + m * 60 + s;
          //   console.log("æ™‚é–“è½‰æ›çµæœ:", t, "->", result + "ç§’");
          return result;
        } else if (parts.length === 2) {
          // è™•ç† MM:SS æ ¼å¼
          const [m, s] = parts;
          if (isNaN(m) || isNaN(s)) {
            // console.log("æ™‚é–“æ ¼å¼éŒ¯èª¤(MM:SS):", t, parts);
            return 0;
          }
          const result = m * 60 + s;
          //   console.log("æ™‚é–“è½‰æ›çµæœ(MM:SS):", t, "->", result + "ç§’");
          return result;
        } else {
          //   console.log("æ™‚é–“æ ¼å¼ä¸æ­£ç¢º:", t, "åˆ†å‰²å¾Œé•·åº¦:", parts.length);
          return 0;
        }
      } catch (error) {
        // console.error("æ™‚é–“è½‰æ›éŒ¯èª¤:", t, error);
        return 0;
      }
    }

    window.onload = fetchAllData;
  </script>
</head>

<body>
  <div class="container">
    <!-- <h1>ğŸ® éŠæˆ²æ•¸æ“šçµ±è¨ˆåˆ†æ</h1> -->
    <div id="stats" class="loading">è®€å–æ•¸æ“šä¸­...</div>
  </div>
</body>

</html>